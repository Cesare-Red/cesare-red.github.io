<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Laurea di Electric Bus 0 - Avventura D&D</title>
    <style>
        :root {
            --primary: #4a148c;
            --secondary: #ff6f00;
            --accent: #00c853;
            --dark: #1a237e;
            --light: #e8eaf6;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, var(--dark), var(--primary));
            color: var(--light);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(0, 0, 0, 0.4);
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }
        
        h1 {
            font-size: 2.8rem;
            margin-bottom: 10px;
            color: var(--secondary);
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        }
        
        h2 {
            font-size: 1.8rem;
            margin: 20px 0;
            color: var(--accent);
        }
        
        .screen {
            display: none;
            background: rgba(26, 35, 126, 0.8);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            border: 2px solid var(--secondary);
        }
        
        .active {
            display: block;
        }
        
        .character-selection {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .character-card {
            background: rgba(74, 20, 140, 0.7);
            border-radius: 10px;
            padding: 15px;
            cursor: pointer;
            transition: transform 0.3s, box-shadow 0.3s;
            border: 2px solid transparent;
        }
        
        .character-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.3);
        }
        
        .character-card.selected {
            border-color: var(--accent);
            background: rgba(74, 20, 140, 0.9);
        }
        
        .character-card h3 {
            color: var(--secondary);
            margin-bottom: 10px;
            font-size: 1.5rem;
        }
        
        .character-card p {
            margin-bottom: 5px;
            font-size: 0.9rem;
        }
        
        .game-area {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
        }
        
        .player-panel {
            flex: 1;
            min-width: 300px;
            background: rgba(0, 0, 0, 0.4);
            border-radius: 10px;
            padding: 15px;
        }
        
        .player-info {
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--secondary);
        }
        
        .player-stats {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }
        
        .stat {
            background: var(--primary);
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 0.9rem;
        }
        
        .dungeon-area {
            flex: 2;
            min-width: 400px;
            background: rgba(0, 0, 0, 0.4);
            border-radius: 10px;
            padding: 15px;
        }
        
        .dungeon-map {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 10px;
            margin: 20px 0;
        }
        
        .map-cell {
            aspect-ratio: 1;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background 0.3s;
        }
        
        .map-cell.active {
            background: var(--accent);
        }
        
        .map-cell.visited {
            background: var(--secondary);
        }
        
        .map-cell.enemy {
            background: #d32f2f;
        }
        
        .map-cell.treasure {
            background: #ffd600;
            color: #000;
        }
        
        .map-cell.boss {
            background: #7b1fa2;
        }
        
        .actions {
            margin-top: 20px;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        button {
            background: var(--secondary);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: background 0.3s, transform 0.2s;
        }
        
        button:hover {
            background: #ff8f00;
            transform: scale(1.05);
        }
        
        button:disabled {
            background: #757575;
            cursor: not-allowed;
            transform: none;
        }
        
        .spell {
            background: var(--primary);
        }
        
        .combat-log {
            margin-top: 20px;
            padding: 10px;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 5px;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .quiz-container {
            background: rgba(0, 0, 0, 0.5);
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
        }
        
        .quiz-question {
            margin-bottom: 15px;
            font-size: 1.1rem;
        }
        
        .quiz-options {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .quiz-option {
            background: rgba(74, 20, 140, 0.7);
            padding: 10px;
            border-radius: 5px;
            cursor: pointer;
            transition: background 0.3s;
        }
        
        .quiz-option:hover {
            background: rgba(74, 20, 140, 0.9);
        }
        
        .quiz-option.correct {
            background: var(--accent);
        }
        
        .quiz-option.incorrect {
            background: #d32f2f;
        }
        
        .battle-arena {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 20px 0;
            padding: 20px;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 10px;
        }
        
        .player-battle, .enemy-battle {
            text-align: center;
            flex: 1;
        }
        
        .battle-sprite {
            width: 150px;
            height: 150px;
            margin: 0 auto;
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
        }
        
        .hp-bar {
            width: 100%;
            height: 20px;
            background: #424242;
            border-radius: 10px;
            margin-top: 10px;
            overflow: hidden;
        }
        
        .hp-fill {
            height: 100%;
            background: var(--accent);
            transition: width 0.5s;
        }
        
        .message {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            text-align: center;
        }
        
        .success {
            background: rgba(0, 200, 83, 0.3);
            border: 1px solid var(--accent);
        }
        
        .warning {
            background: rgba(255, 193, 7, 0.3);
            border: 1px solid #ffc107;
        }
        
        .error {
            background: rgba(211, 47, 47, 0.3);
            border: 1px solid #d32f2f;
        }
        
        @media (max-width: 768px) {
            .game-area {
                flex-direction: column;
            }
            
            .dungeon-map {
                grid-template-columns: repeat(3, 1fr);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Laurea di Electric Bus 0</h1>
            <p>Un'avventura Dungeons & Dragons personalizzata</p>
        </header>
        
        <!-- Schermata di selezione personaggi -->
        <div id="character-selection-screen" class="screen active">
            <h2>Seleziona i Personaggi</h2>
            <p>Scegli quali personaggi parteciperanno all'avventura (almeno uno):</p>
            
            <div class="character-selection">
                <div class="character-card" data-character="vincenzo">
                    <h3>Vincenzo (Electric Bus 0)</h3>
                    <p><strong>Classe:</strong> Mago dell'Algoritmo</p>
                    <p><strong>Ruolo:</strong> DPS / Supporto</p>
                    <p><strong>Incantesimi:</strong> Regressione Lineare, Backpropagation, Overfitting Curse</p>
                </div>
                
                <div class="character-card" data-character="cesare">
                    <h3>Cesare</h3>
                    <p><strong>Classe:</strong> Guerriero del Codice</p>
                    <p><strong>Ruolo:</strong> Tank</p>
                    <p><strong>Incantesimi:</strong> Refactoring, Debug Shield, Code Smash</p>
                </div>
                
                <div class="character-card" data-character="carmela">
                    <h3>Carmela</h3>
                    <p><strong>Classe:</strong> Ranger dei Dati</p>
                    <p><strong>Ruolo:</strong> DPS / Esploratore</p>
                    <p><strong>Incantesimi:</strong> Data Mining, Precision Shot, Outlier Detection</p>
                </div>
                
                <div class="character-card" data-character="william">
                    <h3>William</h3>
                    <p><strong>Classe:</strong> Chierico del Database</p>
                    <p><strong>Ruolo:</strong> Healer / Supporto</p>
                    <p><strong>Incantesimi:</strong> Query Healing, Transaction Protection, Backup Blessing</p>
                </div>
                
                <div class="character-card" data-character="federica">
                    <h3>Federica</h3>
                    <p><strong>Classe:</strong> Ladra dell'UI</p>
                    <p><strong>Ruolo:</strong> DPS / Utility</p>
                    <p><strong>Incantesimi:</strong> CSS Disguise, JavaScript Trick, API Lockpick</p>
                </div>
                
                <div class="character-card" data-character="valentina">
                    <h3>Valentina</h3>
                    <p><strong>Classe:</strong> Stregona del Machine Learning</p>
                    <p><strong>Ruolo:</strong> DPS / Controllo</p>
                    <p><strong>Incantesimi:</strong> Neural Network, Clustering, Feature Extraction</p>
                </div>
            </div>
            
            <div class="actions">
                <button id="start-game">Inizia l'Avventura</button>
            </div>
        </div>
        
        <!-- Schermata del Livello 1 - Minecraft -->
        <div id="level1-screen" class="screen">
            <h2>Livello 1: Le Miniere di Minecraft</h2>
            <p>Esplora il dungeon e affronta le sue sfide!</p>
            
            <div class="game-area">
                <div class="player-panel">
                    <h3>Personaggi</h3>
                    <div id="players-container"></div>
                </div>
                
                <div class="dungeon-area">
                    <h3>Mappa del Dungeon</h3>
                    <div class="dungeon-map" id="minecraft-map">
                        <!-- Le celle della mappa verranno generate dinamicamente -->
                    </div>
                    
                    <div class="actions">
                        <button id="move-forward">Avanti</button>
                        <button id="use-spell">Lancia Incantesimo</button>
                        <button id="rest">Riposa</button>
                    </div>
                    
                    <div class="combat-log" id="combat-log">
                        <p>Benvenuti nelle Miniere di Minecraft! Scegliete una direzione per iniziare.</p>
                    </div>
                </div>
            </div>
            
            <div class="quiz-container" id="quiz-container" style="display: none;">
                <h3>Quiz per Vincenzo</h3>
                <div class="quiz-question" id="quiz-question"></div>
                <div class="quiz-options" id="quiz-options"></div>
            </div>
        </div>
        
        <!-- Schermata del Livello 2 - Harry Potter -->
        <div id="level2-screen" class="screen">
            <h2>Livello 2: Hogwarts e la Magia</h2>
            <p>Affronta le sfide del mondo magico di Harry Potter!</p>
            
            <div class="game-area">
                <div class="player-panel">
                    <h3>Personaggi</h3>
                    <div id="players-container-level2"></div>
                </div>
                
                <div class="dungeon-area">
                    <h3>Castello di Hogwarts</h3>
                    <div class="dungeon-map" id="hogwarts-map">
                        <!-- Le celle della mappa verranno generate dinamicamente -->
                    </div>
                    
                    <div class="battle-arena" id="battle-arena" style="display: none;">
                        <div class="player-battle">
                            <h4 id="current-player-name">Giocatore</h4>
                            <div class="battle-sprite" id="player-sprite"></div>
                            <div class="hp-bar">
                                <div class="hp-fill" id="player-hp-bar" style="width: 100%;"></div>
                            </div>
                            <p id="player-hp-text">HP: 100/100</p>
                        </div>
                        
                        <div class="enemy-battle">
                            <h4 id="enemy-name">Nemico</h4>
                            <div class="battle-sprite" id="enemy-sprite"></div>
                            <div class="hp-bar">
                                <div class="hp-fill" id="enemy-hp-bar" style="width: 100%;"></div>
                            </div>
                            <p id="enemy-hp-text">HP: 100/100</p>
                        </div>
                    </div>
                    
                    <div class="actions">
                        <button id="move-forward-level2">Avanti</button>
                        <button id="use-spell-level2">Lancia Incantesimo</button>
                        <button id="team-attack">Attacco di Squadra</button>
                    </div>
                    
                    <div class="combat-log" id="combat-log-level2">
                        <p>Benvenuti a Hogwarts! Preparatevi ad affrontare le sfide del mondo magico.</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Schermata di vittoria -->
        <div id="victory-screen" class="screen">
            <h2>Congratulazioni!</h2>
            <div class="message success">
                <p>Hai completato con successo l'avventura per celebrare la laurea di Vincenzo!</p>
                <p>Tutti i personaggi hanno guadagnato punti caratteristica permanenti.</p>
            </div>
            
            <h3>Riepilogo Finale</h3>
            <div id="final-stats"></div>
            
            <div class="actions">
                <button id="play-again">Gioca di Nuovo</button>
            </div>
        </div>
    </div>

    <script>
        // Definizione dei personaggi
        const characters = {
            vincenzo: {
                name: "Vincenzo (Electric Bus 0)",
                class: "Mago dell'Algoritmo",
                role: "DPS/Supporto",
                hp: 80,
                maxHp: 80,
                attack: 12,
                defense: 8,
                speed: 10,
                spells: [
                    { name: "Regressione Lineare", damage: 15, cost: 10, type: "attack" },
                    { name: "Backpropagation", damage: 0, cost: 15, type: "heal", value: 20 },
                    { name: "Overfitting Curse", damage: 10, cost: 12, type: "attack" }
                ],
                selected: true
            },
            cesare: {
                name: "Cesare",
                class: "Guerriero del Codice",
                role: "Tank",
                hp: 120,
                maxHp: 120,
                attack: 10,
                defense: 15,
                speed: 7,
                spells: [
                    { name: "Refactoring", damage: 12, cost: 8, type: "attack" },
                    { name: "Debug Shield", damage: 0, cost: 10, type: "defense", value: 15 },
                    { name: "Code Smash", damage: 18, cost: 15, type: "attack" }
                ],
                selected: false
            },
            carmela: {
                name: "Carmela",
                class: "Ranger dei Dati",
                role: "DPS/Esploratore",
                hp: 90,
                maxHp: 90,
                attack: 14,
                defense: 9,
                speed: 12,
                spells: [
                    { name: "Data Mining", damage: 16, cost: 12, type: "attack" },
                    { name: "Precision Shot", damage: 20, cost: 15, type: "attack" },
                    { name: "Outlier Detection", damage: 0, cost: 10, type: "utility" }
                ],
                selected: false
            },
            william: {
                name: "William",
                class: "Chierico del Database",
                role: "Healer/Supporto",
                hp: 85,
                maxHp: 85,
                attack: 8,
                defense: 10,
                speed: 9,
                spells: [
                    { name: "Query Healing", damage: 0, cost: 12, type: "heal", value: 25 },
                    { name: "Transaction Protection", damage: 0, cost: 15, type: "defense", value: 20 },
                    { name: "Backup Blessing", damage: 0, cost: 20, type: "heal", value: 40 }
                ],
                selected: false
            },
            federica: {
                name: "Federica",
                class: "Ladra dell'UI",
                role: "DPS/Utility",
                hp: 75,
                maxHp: 75,
                attack: 13,
                defense: 8,
                speed: 14,
                spells: [
                    { name: "CSS Disguise", damage: 0, cost: 10, type: "utility" },
                    { name: "JavaScript Trick", damage: 14, cost: 12, type: "attack" },
                    { name: "API Lockpick", damage: 0, cost: 15, type: "utility" }
                ],
                selected: false
            },
            valentina: {
                name: "Valentina",
                class: "Stregona del Machine Learning",
                role: "DPS/Controllo",
                hp: 80,
                maxHp: 80,
                attack: 15,
                defense: 8,
                speed: 11,
                spells: [
                    { name: "Neural Network", damage: 18, cost: 15, type: "attack" },
                    { name: "Clustering", damage: 12, cost: 10, type: "attack" },
                    { name: "Feature Extraction", damage: 0, cost: 12, type: "utility" }
                ],
                selected: false
            }
        };

        // Variabili di gioco
        let selectedCharacters = [];
        let currentLevel = 1;
        let currentPlayerIndex = 0;
        let currentEnemy = null;
        let gameState = "exploring"; // exploring, combat, quiz, boss
        let currentPosition = 0;
        let dungeonMap = [];
        let quizQuestions = [];
        let currentQuizQuestion = null;

        // Inizializzazione del gioco
        document.addEventListener('DOMContentLoaded', function() {
            // Selezione personaggi
            const characterCards = document.querySelectorAll('.character-card');
            characterCards.forEach(card => {
                card.addEventListener('click', function() {
                    const characterId = this.getAttribute('data-character');
                    characters[characterId].selected = !characters[characterId].selected;
                    this.classList.toggle('selected');
                    
                    // Aggiorna lista personaggi selezionati
                    selectedCharacters = Object.values(characters).filter(char => char.selected);
                });
            });
            
            // Avvia il gioco
            document.getElementById('start-game').addEventListener('click', function() {
                if (selectedCharacters.length === 0) {
                    alert('Seleziona almeno un personaggio!');
                    return;
                }
                
                // Inizializza i personaggi selezionati
                selectedCharacters.forEach(char => {
                    // Reset delle statistiche per una nuova partita
                    char.hp = char.maxHp;
                });
                
                startLevel(1);
            });
            
            // Movimento nel livello 1
            document.getElementById('move-forward').addEventListener('click', moveForward);
            
            // Movimento nel livello 2
            document.getElementById('move-forward-level2').addEventListener('click', moveForwardLevel2);
            
            // Riproduci nuovamente
            document.getElementById('play-again').addEventListener('click', function() {
                location.reload();
            });
        });

        // Funzione per iniziare un livello
        function startLevel(level) {
            currentLevel = level;
            currentPlayerIndex = 0;
            currentPosition = 0;
            gameState = "exploring";
            
            // Nascondi tutte le schermate e mostra quella corretta
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active');
            });
            
            if (level === 1) {
                document.getElementById('level1-screen').classList.add('active');
                initializeLevel1();
            } else if (level === 2) {
                document.getElementById('level2-screen').classList.add('active');
                initializeLevel2();
            }
            
            // Aggiorna il pannello dei giocatori
            updatePlayerPanel();
        }

        // Inizializza il livello 1 (Minecraft)
        function initializeLevel1() {
            // Crea la mappa del dungeon
            dungeonMap = [
                { type: 'start', visited: true },
                { type: 'path', visited: false },
                { type: 'enemy', visited: false, enemy: { name: 'Creeper', hp: 30, attack: 8, defense: 5 } },
                { type: 'treasure', visited: false },
                { type: 'path', visited: false },
                { type: 'enemy', visited: false, enemy: { name: 'Zombie', hp: 25, attack: 6, defense: 4 } },
                { type: 'path', visited: false },
                { type: 'trap', visited: false },
                { type: 'path', visited: false },
                { type: 'boss', visited: false, enemy: { name: 'Ender Dragon', hp: 50, attack: 12, defense: 8 } },
                { type: 'quiz', visited: false }
            ];
            
            // Inizializza la mappa visiva
            const mapContainer = document.getElementById('minecraft-map');
            mapContainer.innerHTML = '';
            
            dungeonMap.forEach((cell, index) => {
                const cellElement = document.createElement('div');
                cellElement.className = 'map-cell';
                cellElement.textContent = index + 1;
                
                if (cell.type === 'start') {
                    cellElement.classList.add('visited');
                } else if (cell.type === 'enemy') {
                    cellElement.classList.add('enemy');
                } else if (cell.type === 'treasure') {
                    cellElement.classList.add('treasure');
                } else if (cell.type === 'boss') {
                    cellElement.classList.add('boss');
                }
                
                if (index === currentPosition) {
                    cellElement.classList.add('active');
                }
                
                mapContainer.appendChild(cellElement);
            });
            
            // Inizializza le domande del quiz
            quizQuestions = [
                {
                    question: "In Harry Potter, qual è il nome della scuola di magia?",
                    options: ["Hogwarts", "Beauxbatons", "Durmstrang", "Ilvermorny"],
                    correct: 0
                },
                {
                    question: "In Breaking Bad, qual è il nome del protagonista?",
                    options: ["Walter White", "Jesse Pinkman", "Saul Goodman", "Gus Fring"],
                    correct: 0
                },
                {
                    question: "In Machine Learning, cos'è l'overfitting?",
                    options: [
                        "Quando un modello si adatta troppo ai dati di training", 
                        "Quando un modello non si adatta ai dati", 
                        "Quando un modello è troppo semplice", 
                        "Quando un modello ha troppi parametri"
                    ],
                    correct: 0
                }
            ];
            
            // Aggiorna il log di combattimento
            updateCombatLog("Benvenuti nelle Miniere di Minecraft! Iniziate l'esplorazione.");
        }

        // Inizializza il livello 2 (Harry Potter)
        function initializeLevel2() {
            // Crea la mappa del castello di Hogwarts
            dungeonMap = [
                { type: 'start', visited: true },
                { type: 'path', visited: false },
                { type: 'enemy', visited: false, enemy: { name: 'Dementor', hp: 35, attack: 10, defense: 6 } },
                { type: 'treasure', visited: false },
                { type: 'path', visited: false },
                { type: 'enemy', visited: false, enemy: { name: 'Basilisk', hp: 40, attack: 12, defense: 8 } },
                { type: 'path', visited: false },
                { type: 'trap', visited: false },
                { type: 'path', visited: false },
                { type: 'boss', visited: false, enemy: { name: 'Voldemort', hp: 80, attack: 15, defense: 10 } }
            ];
            
            // Inizializza la mappa visiva
            const mapContainer = document.getElementById('hogwarts-map');
            mapContainer.innerHTML = '';
            
            dungeonMap.forEach((cell, index) => {
                const cellElement = document.createElement('div');
                cellElement.className = 'map-cell';
                cellElement.textContent = index + 1;
                
                if (cell.type === 'start') {
                    cellElement.classList.add('visited');
                } else if (cell.type === 'enemy') {
                    cellElement.classList.add('enemy');
                } else if (cell.type === 'treasure') {
                    cellElement.classList.add('treasure');
                } else if (cell.type === 'boss') {
                    cellElement.classList.add('boss');
                }
                
                if (index === currentPosition) {
                    cellElement.classList.add('active');
                }
                
                mapContainer.appendChild(cellElement);
            });
            
            // Aggiorna il log di combattimento
            updateCombatLogLevel2("Benvenuti a Hogwarts! Preparatevi ad affrontare le sfide del mondo magico.");
        }

        // Aggiorna il pannello dei giocatori
        function updatePlayerPanel() {
            const containerId = currentLevel === 1 ? 'players-container' : 'players-container-level2';
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            
            selectedCharacters.forEach((player, index) => {
                const playerElement = document.createElement('div');
                playerElement.className = 'player-info';
                playerElement.innerHTML = `
                    <h4>${player.name} ${index === currentPlayerIndex ? '(Attivo)' : ''}</h4>
                    <p>Classe: ${player.class}</p>
                    <p>Ruolo: ${player.role}</p>
                    <div class="player-stats">
                        <div class="stat">HP: ${player.hp}/${player.maxHp}</div>
                        <div class="stat">Attacco: ${player.attack}</div>
                        <div class="stat">Difesa: ${player.defense}</div>
                        <div class="stat">Velocità: ${player.speed}</div>
                    </div>
                `;
                container.appendChild(playerElement);
            });
        }

        // Movimento in avanti nel livello 1
        function moveForward() {
            if (gameState !== "exploring") return;
            
            if (currentPosition < dungeonMap.length - 1) {
                currentPosition++;
                
                // Aggiorna la mappa visiva
                const mapCells = document.querySelectorAll('#minecraft-map .map-cell');
                mapCells.forEach((cell, index) => {
                    cell.classList.remove('active');
                    if (index === currentPosition) {
                        cell.classList.add('active');
                    }
                    if (index <= currentPosition) {
                        cell.classList.add('visited');
                    }
                });
                
                // Gestisci l'evento della cella
                const currentCell = dungeonMap[currentPosition];
                handleCellEvent(currentCell);
            } else {
                updateCombatLog("Sei arrivato alla fine del dungeon!");
            }
        }

        // Movimento in avanti nel livello 2
        function moveForwardLevel2() {
            if (gameState !== "exploring") return;
            
            if (currentPosition < dungeonMap.length - 1) {
                currentPosition++;
                
                // Aggiorna la mappa visiva
                const mapCells = document.querySelectorAll('#hogwarts-map .map-cell');
                mapCells.forEach((cell, index) => {
                    cell.classList.remove('active');
                    if (index === currentPosition) {
                        cell.classList.add('active');
                    }
                    if (index <= currentPosition) {
                        cell.classList.add('visited');
                    }
                });
                
                // Gestisci l'evento della cella
                const currentCell = dungeonMap[currentPosition];
                handleCellEventLevel2(currentCell);
            } else {
                updateCombatLogLevel2("Sei arrivato alla fine del castello!");
            }
        }

        // Gestisci gli eventi delle celle nel livello 1
        function handleCellEvent(cell) {
            switch(cell.type) {
                case 'enemy':
                    gameState = "combat";
                    currentEnemy = cell.enemy;
                    updateCombatLog(`Incontri un ${currentEnemy.name}! Preparati al combattimento.`);
                    startCombat();
                    break;
                case 'treasure':
                    updateCombatLog("Hai trovato un tesoro! Tutti i personaggi guadagnano +2 all'attacco.");
                    selectedCharacters.forEach(char => {
                        char.attack += 2;
                    });
                    updatePlayerPanel();
                    break;
                case 'trap':
                    updateCombatLog("Caduta in una trappola! Tutti i personaggi perdono 10 HP.");
                    selectedCharacters.forEach(char => {
                        char.hp = Math.max(1, char.hp - 10);
                    });
                    updatePlayerPanel();
                    break;
                case 'boss':
                    gameState = "combat";
                    currentEnemy = cell.enemy;
                    updateCombatLog(`Affronti il boss: ${currentEnemy.name}!`);
                    startCombat();
                    break;
                case 'quiz':
                    gameState = "quiz";
                    startQuiz();
                    break;
                default:
                    updateCombatLog("Prosegui attraverso il dungeon...");
            }
        }

        // Gestisci gli eventi delle celle nel livello 2
        function handleCellEventLevel2(cell) {
            switch(cell.type) {
                case 'enemy':
                    gameState = "combat";
                    currentEnemy = cell.enemy;
                    updateCombatLogLevel2(`Incontri un ${currentEnemy.name}! Preparati al combattimento.`);
                    startCombatLevel2();
                    break;
                case 'treasure':
                    updateCombatLogLevel2("Hai trovato una pozione magica! Tutti i personaggi guadagnano +3 alla difesa.");
                    selectedCharacters.forEach(char => {
                        char.defense += 3;
                    });
                    updatePlayerPanel();
                    break;
                case 'trap':
                    updateCombatLogLevel2("Sei caduto in una maledizione! Tutti i personaggi perdono 15 HP.");
                    selectedCharacters.forEach(char => {
                        char.hp = Math.max(1, char.hp - 15);
                    });
                    updatePlayerPanel();
                    break;
                case 'boss':
                    gameState = "combat";
                    currentEnemy = cell.enemy;
                    updateCombatLogLevel2(`Affronti il boss finale: ${currentEnemy.name}!`);
                    startBossBattle();
                    break;
                default:
                    updateCombatLogLevel2("Prosegui attraverso il castello...");
            }
        }

        // Inizia un combattimento nel livello 1
        function startCombat() {
            updateCombatLog(`Combatti contro ${currentEnemy.name}!`);
            
            // Simula un turno di combattimento
            const currentPlayer = selectedCharacters[currentPlayerIndex];
            const playerAttack = Math.max(1, currentPlayer.attack + Math.floor(Math.random() * 6) - currentEnemy.defense);
            currentEnemy.hp -= playerAttack;
            
            updateCombatLog(`${currentPlayer.name} attacca e infligge ${playerAttack} danni a ${currentEnemy.name}.`);
            
            if (currentEnemy.hp <= 0) {
                updateCombatLog(`Hai sconfitto ${currentEnemy.name}!`);
                gameState = "exploring";
                currentPlayerIndex = (currentPlayerIndex + 1) % selectedCharacters.length;
                updatePlayerPanel();
                return;
            }
            
            // Il nemico contrattacca
            const enemyAttack = Math.max(1, currentEnemy.attack + Math.floor(Math.random() * 4) - currentPlayer.defense);
            currentPlayer.hp -= enemyAttack;
            
            updateCombatLog(`${currentEnemy.name} contrattacca e infligge ${enemyAttack} danni a ${currentPlayer.name}.`);
            
            if (currentPlayer.hp <= 0) {
                updateCombatLog(`${currentPlayer.name} è stato sconfitto!`);
                // Rimuovi il personaggio dalla lista o gestisci la sconfitta
                selectedCharacters.splice(currentPlayerIndex, 1);
                
                if (selectedCharacters.length === 0) {
                    updateCombatLog("Tutti i personaggi sono stati sconfitti. Game Over!");
                    return;
                }
                
                currentPlayerIndex = currentPlayerIndex % selectedCharacters.length;
            }
            
            updatePlayerPanel();
            
            // Passa al prossimo giocatore
            currentPlayerIndex = (currentPlayerIndex + 1) % selectedCharacters.length;
        }

        // Inizia un combattimento nel livello 2
        function startCombatLevel2() {
            updateCombatLogLevel2(`Combatti contro ${currentEnemy.name}!`);
            
            // Mostra l'arena di combattimento
            document.getElementById('battle-arena').style.display = 'flex';
            document.getElementById('current-player-name').textContent = selectedCharacters[currentPlayerIndex].name;
            document.getElementById('enemy-name').textContent = currentEnemy.name;
            
            // Simula un turno di combattimento
            const currentPlayer = selectedCharacters[currentPlayerIndex];
            const playerAttack = Math.max(1, currentPlayer.attack + Math.floor(Math.random() * 6) - currentEnemy.defense);
            currentEnemy.hp -= playerAttack;
            
            updateCombatLogLevel2(`${currentPlayer.name} attacca e infligge ${playerAttack} danni a ${currentEnemy.name}.`);
            
            // Aggiorna le barre HP
            updateHPBars();
            
            if (currentEnemy.hp <= 0) {
                updateCombatLogLevel2(`Hai sconfitto ${currentEnemy.name}!`);
                gameState = "exploring";
                document.getElementById('battle-arena').style.display = 'none';
                currentPlayerIndex = (currentPlayerIndex + 1) % selectedCharacters.length;
                updatePlayerPanel();
                return;
            }
            
            // Il nemico contrattacca
            const enemyAttack = Math.max(1, currentEnemy.attack + Math.floor(Math.random() * 4) - currentPlayer.defense);
            currentPlayer.hp -= enemyAttack;
            
            updateCombatLogLevel2(`${currentEnemy.name} contrattacca e infligge ${enemyAttack} danni a ${currentPlayer.name}.`);
            
            // Aggiorna le barre HP
            updateHPBars();
            
            if (currentPlayer.hp <= 0) {
                updateCombatLogLevel2(`${currentPlayer.name} è stato sconfitto!`);
                // Rimuovi il personaggio dalla lista o gestisci la sconfitta
                selectedCharacters.splice(currentPlayerIndex, 1);
                
                if (selectedCharacters.length === 0) {
                    updateCombatLogLevel2("Tutti i personaggi sono stati sconfitti. Game Over!");
                    return;
                }
                
                currentPlayerIndex = currentPlayerIndex % selectedCharacters.length;
            }
            
            updatePlayerPanel();
            
            // Passa al prossimo giocatore
            currentPlayerIndex = (currentPlayerIndex + 1) % selectedCharacters.length;
        }

        // Inizia la battaglia contro il boss
        function startBossBattle() {
            updateCombatLogLevel2(`Combatti contro ${currentEnemy.name}! Questa è una battaglia epica!`);
            
            // Mostra l'arena di combattimento
            document.getElementById('battle-arena').style.display = 'flex';
            document.getElementById('current-player-name').textContent = "Squadra";
            document.getElementById('enemy-name').textContent = currentEnemy.name;
            
            // Il boss ha attacchi speciali
            const specialAttacks = [
                "Attacco a tutti",
                "Stordimento",
                "Demenza (attacca un alleato)"
            ];
            
            // Simula un turno di combattimento di squadra
            let totalDamage = 0;
            selectedCharacters.forEach(player => {
                const playerAttack = Math.max(1, player.attack + Math.floor(Math.random() * 6) - currentEnemy.defense);
                totalDamage += playerAttack;
            });
            
            currentEnemy.hp -= totalDamage;
            
            updateCombatLogLevel2(`La squadra attacca e infligge ${totalDamage} danni a ${currentEnemy.name}.`);
            
            // Aggiorna le barre HP
            updateHPBars();
            
            if (currentEnemy.hp <= 0) {
                updateCombatLogLevel2(`Hai sconfitto ${currentEnemy.name}! Complimenti, hai completato l'avventura!`);
                endGame();
                return;
            }
            
            // Il boss usa un attacco speciale
            const specialAttack = specialAttacks[Math.floor(Math.random() * specialAttacks.length)];
            updateCombatLogLevel2(`${currentEnemy.name} usa ${specialAttack}!`);
            
            if (specialAttack === "Attacco a tutti") {
                selectedCharacters.forEach(player => {
                    const damage = Math.max(1, Math.floor(Math.random() * 10) + 5 - player.defense);
                    player.hp -= damage;
                    updateCombatLogLevel2(`${player.name} subisce ${damage} danni.`);
                });
            } else if (specialAttack === "Stordimento") {
                const stunnedPlayer = selectedCharacters[Math.floor(Math.random() * selectedCharacters.length)];
                updateCombatLogLevel2(`${stunnedPlayer.name} è stordito e salta il prossimo turno!`);
            } else if (specialAttack === "Demenza (attacca un alleato)") {
                const attacker = selectedCharacters[Math.floor(Math.random() * selectedCharacters.length)];
                const target = selectedCharacters[Math.floor(Math.random() * selectedCharacters.length)];
                if (attacker !== target) {
                    const damage = Math.max(1, Math.floor(Math.random() * 8) + 3);
                    target.hp -= damage;
                    updateCombatLogLevel2(`${attacker.name}, affetto da demenza, attacca ${target.name} infliggendo ${damage} danni!`);
                }
            }
            
            // Aggiorna le barre HP
            updateHPBars();
            
            // Controlla se qualche personaggio è stato sconfitto
            for (let i = selectedCharacters.length - 1; i >= 0; i--) {
                if (selectedCharacters[i].hp <= 0) {
                    updateCombatLogLevel2(`${selectedCharacters[i].name} è stato sconfitto!`);
                    selectedCharacters.splice(i, 1);
                }
            }
            
            if (selectedCharacters.length === 0) {
                updateCombatLogLevel2("Tutti i personaggi sono stati sconfitti. Game Over!");
                return;
            }
            
            updatePlayerPanel();
        }

        // Aggiorna le barre HP durante il combattimento
        function updateHPBars() {
            const currentPlayer = selectedCharacters[currentPlayerIndex];
            const playerHpPercent = (currentPlayer.hp / currentPlayer.maxHp) * 100;
            document.getElementById('player-hp-bar').style.width = `${playerHpPercent}%`;
            document.getElementById('player-hp-text').textContent = `HP: ${currentPlayer.hp}/${currentPlayer.maxHp}`;
            
            const enemyHpPercent = (currentEnemy.hp / currentEnemy.maxHp) * 100;
            document.getElementById('enemy-hp-bar').style.width = `${enemyHpPercent}%`;
            document.getElementById('enemy-hp-text').textContent = `HP: ${currentEnemy.hp}/${currentEnemy.maxHp}`;
        }

        // Inizia il quiz
        function startQuiz() {
            document.getElementById('quiz-container').style.display = 'block';
            
            // Seleziona una domanda casuale
            currentQuizQuestion = quizQuestions[Math.floor(Math.random() * quizQuestions.length)];
            
            document.getElementById('quiz-question').textContent = currentQuizQuestion.question;
            
            const optionsContainer = document.getElementById('quiz-options');
            optionsContainer.innerHTML = '';
            
            currentQuizQuestion.options.forEach((option, index) => {
                const optionElement = document.createElement('div');
                optionElement.className = 'quiz-option';
                optionElement.textContent = option;
                optionElement.addEventListener('click', function() {
                    checkQuizAnswer(index);
                });
                optionsContainer.appendChild(optionElement);
            });
        }

        // Controlla la risposta del quiz
        function checkQuizAnswer(selectedIndex) {
            const options = document.querySelectorAll('.quiz-option');
            
            options.forEach((option, index) => {
                if (index === currentQuizQuestion.correct) {
                    option.classList.add('correct');
                } else if (index === selectedIndex) {
                    option.classList.add('incorrect');
                }
            });
            
            if (selectedIndex === currentQuizQuestion.correct) {
                updateCombatLog("Risposta corretta! Il quiz è superato. Tutti i personaggi ricevono +1 a ogni caratteristica.");
                
                // Bonus per aver superato il quiz
                selectedCharacters.forEach(char => {
                    char.maxHp += 10;
                    char.hp = char.maxHp;
                    char.attack += 1;
                    char.defense += 1;
                    char.speed += 1;
                });
                
                updatePlayerPanel();
                
                // Passa al livello successivo dopo un breve ritardo
                setTimeout(() => {
                    document.getElementById('quiz-container').style.display = 'none';
                    startLevel(2);
                }, 3000);
            } else {
                updateCombatLog("Risposta errata! Riprova.");
                
                // Dopo un breve ritardo, riproponi il quiz
                setTimeout(() => {
                    document.getElementById('quiz-container').style.display = 'none';
                    startQuiz();
                }, 2000);
            }
        }

        // Termina il gioco e mostra la schermata di vittoria
        function endGame() {
            // Bonus per aver completato il gioco
            selectedCharacters.forEach(char => {
                char.attack += 3;
                char.defense += 3;
                char.speed += 3;
            });
            
            // Nascondi tutte le schermate e mostra quella di vittoria
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active');
            });
            
            document.getElementById('victory-screen').classList.add('active');
            
            // Mostra le statistiche finali
            const finalStatsContainer = document.getElementById('final-stats');
            finalStatsContainer.innerHTML = '';
            
            selectedCharacters.forEach(char => {
                const statElement = document.createElement('div');
                statElement.className = 'player-info';
                statElement.innerHTML = `
                    <h4>${char.name}</h4>
                    <p>Classe: ${char.class}</p>
                    <div class="player-stats">
                        <div class="stat">HP: ${char.hp}/${char.maxHp}</div>
                        <div class="stat">Attacco: ${char.attack}</div>
                        <div class="stat">Difesa: ${char.defense}</div>
                        <div class="stat">Velocità: ${char.speed}</div>
                    </div>
                `;
                finalStatsContainer.appendChild(statElement);
            });
        }

        // Aggiorna il log di combattimento nel livello 1
        function updateCombatLog(message) {
            const log = document.getElementById('combat-log');
            log.innerHTML += `<p>${message}</p>`;
            log.scrollTop = log.scrollHeight;
        }

        // Aggiorna il log di combattimento nel livello 2
        function updateCombatLogLevel2(message) {
            const log = document.getElementById('combat-log-level2');
            log.innerHTML += `<p>${message}</p>`;
            log.scrollTop = log.scrollHeight;
        }
    </script>
</body>
</html>